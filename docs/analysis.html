<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
  <meta charset="utf-8">
  <meta name="generator" content="quarto-99.9.9">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="James Goldie, 360info">
  <meta name="dcterms.date" content="2022-03-15">
  <title>Global education</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>

  <script src="analysis_files/libs/clipboard/clipboard.min.js"></script>
  <script src="analysis_files/libs/quarto-html/quarto.js"></script>
  <script src="analysis_files/libs/quarto-html/popper.min.js"></script>
  <script src="analysis_files/libs/quarto-html/tippy.umd.min.js"></script>
  <script src="analysis_files/libs/quarto-html/anchor.min.js"></script>
  <link href="analysis_files/libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="analysis_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="analysis_files/libs/bootstrap/bootstrap.min.js"></script>
  <link href="analysis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="analysis_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet">
  <script type="module" src="analysis_files/libs/quarto-ojs/esbuild-bundle.js"></script>
  <link href="analysis_files/libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body class="fullcontent">
<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content page-columns page-full" id="quarto-document-content">
<header id="title-block-header" class="quarto-title-block default">



<div class="quarto-title"><h1 class="title display-7">Global education</h1></div><div class="quarto-title-meta"><div><div class="quarto-title-meta-heading">Author</div><div class="quarto-title-meta-contents"><div class="quarto-title-authors"><div>James Goldie, 360info</div></div></div></div><div><div class="quarto-title-meta-heading">Published</div><div class="quarto-title-meta-contents"><p class="date">March 15, 2022</p></div></div></div></header>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell" data-hash="analysis_cache/html/setup_a248028bc4c2864d2d1f71dc783033bd">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(here)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pins)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>Linking to GEOS 3.9.1, GDAL 3.2.3, PROJ 7.2.1</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CoordinateCleaner)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(countrycode)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>
Attaching package: 'igraph'</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>The following objects are masked from 'package:dplyr':

    as_data_frame, groups, union</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>The following objects are masked from 'package:purrr':

    compose, simplify</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>The following object is masked from 'package:tidyr':

    crossing</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>The following object is masked from 'package:tibble':

    as_data_frame</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    decompose, spectrum</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    union</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb11"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wbstats)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themes360info)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">register_360fonts</span>(<span class="st">"libre"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>✔ Using preferred font, Libre Franklin.
ℹ Specify a different font to use with 360info themes by calling
  register_360fonts() or by setting options("themes360info.franklin.pref") to
  either "itc" or "libre" (or "none" to disable automatic font loading).</code></pre>
</div>
<div class="cell-output-stdout">
<pre><code>NULL</code></pre>
</div>
</div>
</section>
<section id="getting-the-data" class="level2">
<h2 class="anchored" data-anchor-id="getting-the-data">Getting the data</h2>
<p>This data comes from the <a href="http://data.uis.unesco.org">UNESCO Institute for Statistics (UIS)</a>.</p>
<p>We’ll use their <a href="https://apiportal.uis.unesco.org/bdds">Bulk Data Download Service</a> to acquire the data quickly, but we’re particularly interested in the indicators within the Education theme labelled <code>Number and rates of international mobile students (inbound and outbound)</code>.</p>
<div class="cell" data-hash="analysis_cache/html/import_a2a6ef8a1a9a77b1ce6f75aeae8eb84b">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb14"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_cache <span class="ot">&lt;-</span> <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">".cache"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(data_cache, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># download the zip file (keeping it cached if we redo this)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>zipped_data <span class="ot">&lt;-</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">board_url</span>(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="at">opri =</span> <span class="fu">paste0</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"https://apimgmtstzgjpfeq2u763lag.blob.core.windows.net/"</span>,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"content/MediaLibrary/bdds/OPRI.zip"</span>)),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">cache =</span> data_cache) <span class="sc">%&gt;%</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pin_download</span>(<span class="st">"opri"</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># unzip it </span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(zipped_data, <span class="at">exdir =</span> data_cache)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># read the coding sheets in</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>country_map <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(data_cache, <span class="st">"OPRI_COUNTRY.csv"</span>), <span class="at">col_types =</span> <span class="st">"cc"</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>indicator_map <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(data_cache, <span class="st">"OPRI_LABEL.csv"</span>),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_types =</span> <span class="st">"cc"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>region_map <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">file.path</span>(data_cache, <span class="st">"OPRI_REGION.csv"</span>), <span class="at">col_types =</span> <span class="st">"ccc"</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co"># read the data in</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>national_data <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file.path</span>(data_cache, <span class="st">"OPRI_DATA_NATIONAL.csv"</span>),</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_types =</span> <span class="st">"ccincc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="tidying-and-joining-the-origin-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="tidying-and-joining-the-origin-data">Tidying and joining the origin data</h2>
<p>This data is two dimensional, in a way: there’s the country students go from (that is, the <em>origin</em>) and the country that go to (the <em>destination</em>). The way the data is organised into indicators by origin (<code>"[continent]: "Students from" [country], both sexes (number)"</code>), and within that indicator there’s a row for each destination, each year.</p>
<p>So you can easily look up where a country’s students have gone. If you want to look up where a country’s students have come from, though, you would need to tally up the destination row for a country in <em>every</em> origin indicator. That’s what we’re going to do (with the implicit assumption that there are no countries missing).</p>
<p>The national data already has a destination column. It also has an indicator number column, and we need to map that back to a country code using the label map and the country map.</p>
<div class="cell" data-hash="analysis_cache/html/labelmap_99eabeafe98b906499dc428379719549">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first, isolate the continent and country of origin</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>indicator_map <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(INDICATOR_LABEL_EN, <span class="st">"Students from"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">INDICATOR_LABEL_EN =</span> <span class="fu">str_replace</span>(INDICATOR_LABEL_EN,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fixed</span>(<span class="st">", both sexes (number)"</span>), <span class="st">""</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">INDICATOR_LABEL_EN =</span> <span class="fu">str_replace</span>(INDICATOR_LABEL_EN,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fixed</span>(<span class="st">" Students from "</span>), <span class="st">""</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(INDICATOR_LABEL_EN, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"continent"</span>, <span class="st">"country"</span>), <span class="at">sep =</span> <span class="st">":"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># some indicators also preface country name with "the "</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">country =</span> <span class="fu">str_replace</span>(country, <span class="st">"^the "</span>, <span class="st">""</span>)) <span class="ot">-&gt;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>tidy_origins</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># now match these to the country map</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>tidy_origins <span class="sc">%&gt;%</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(country_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country"</span> <span class="ot">=</span> <span class="st">"COUNTRY_NAME_EN"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># we'll use {countrycode} as a backup for the un country list,</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># since they aren't always entirely consistent</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">countrycode_backup =</span> <span class="fu">countrycode</span>(country,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">origin =</span> <span class="st">"country.name"</span>, <span class="at">destination =</span> <span class="st">"iso3c"</span>),</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">code =</span> <span class="fu">coalesce</span>(COUNTRY_ID, countrycode_backup)) <span class="sc">%&gt;%</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(INDICATOR_ID,</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    continent,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">country_name =</span> country,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">country_code =</span> code) <span class="sc">%&gt;%</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># finally, let's neaten a few country names up</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mutate(l = nchar(country_name)) %&gt;% arrange(desc(l)) %&gt;%</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select(country_name, country_code, l)</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">country_name =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"HKG"</span> <span class="sc">~</span> <span class="st">"Hong Kong"</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"MAC"</span> <span class="sc">~</span> <span class="st">"Macao"</span>,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"PRK"</span> <span class="sc">~</span> <span class="st">"North Korea"</span>,</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"COD"</span> <span class="sc">~</span> <span class="st">"DR Congo"</span>,</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"VCT"</span> <span class="sc">~</span> <span class="st">"St Vincent/Grenadines"</span>,</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"VEN"</span> <span class="sc">~</span> <span class="st">"Venezuala"</span>,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"LAO"</span> <span class="sc">~</span> <span class="st">"Laos"</span>,</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"BOL"</span> <span class="sc">~</span> <span class="st">"Bolivia"</span>,</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"FSM"</span> <span class="sc">~</span> <span class="st">"Micronesia"</span>,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"TZA"</span> <span class="sc">~</span> <span class="st">"Tanzania"</span>,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"IRN"</span> <span class="sc">~</span> <span class="st">"Iran"</span>,</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"RUS"</span> <span class="sc">~</span> <span class="st">"Russia"</span>,</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"MDA"</span> <span class="sc">~</span> <span class="st">"Moldova"</span>,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>      country_code <span class="sc">==</span> <span class="st">"SYR"</span> <span class="sc">~</span> <span class="st">"Syria"</span>,</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> country_name)) <span class="sc">%&gt;%</span></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"country-names.csv"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>indicator_origin_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>Warning in countrycode_convert(sourcevar = sourcevar, origin = origin, destination = dest, : Some values were not matched unambiguously: Netherlands Antilles, Sudan (pre-secession), unknown countries</code></pre>
</div>
</div>
<p>Note that we still have a few unmapped country codes: those cases where the origin <em>continent</em> is known but not the <em>country</em>:</p>
<div class="cell page-columns page-full" data-hash="analysis_cache/html/missingcountries_558a96a8fcfe231dee3969e9386f2343">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb17"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>indicator_origin_map <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(country_code)) <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display column-page">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 17%">
<col style="width: 40%">
<col style="width: 24%">
<col style="width: 17%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">INDICATOR_ID</th>
<th style="text-align: left;">continent</th>
<th style="text-align: left;">country_name</th>
<th style="text-align: left;">country_code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">26474</td>
<td style="text-align: left;">Africa</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">26504</td>
<td style="text-align: left;">North America</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">26518</td>
<td style="text-align: left;">South America</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">26570</td>
<td style="text-align: left;">Asia</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">26615</td>
<td style="text-align: left;">Europe</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">26630</td>
<td style="text-align: left;">Oceania</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">26651</td>
<td style="text-align: left;">Caribbean and Central America</td>
<td style="text-align: left;">unknown countries</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>That’s okay! Now we’re ready to map these codes back onto the national data:</p>
<div class="cell" data-hash="analysis_cache/html/nationaldata_ad948354fbf3dd96190453ab6675dac8">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb18"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>national_data <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(INDICATOR_ID, <span class="at">dest_country_code =</span> COUNTRY_ID, <span class="at">year =</span> YEAR,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> VALUE, <span class="at">magnitude =</span> MAGNITUDE, <span class="at">qualifier =</span> QUALIFIER) <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># join the origin map in</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(INDICATOR_ID <span class="sc">%in%</span> indicator_origin_map<span class="sc">$</span>INDICATOR_ID) <span class="sc">%&gt;%</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(indicator_origin_map, <span class="at">by =</span> <span class="st">"INDICATOR_ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">origin_continent =</span> continent, <span class="at">origin_country_name =</span> country_name,</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">origin_country_code =</span> country_code) <span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now we're going to join it _again_, but this time to get  the _destination_</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># name and continent</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(indicator_origin_map,</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest_country_code"</span> <span class="ot">=</span> <span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">dest_continent =</span> continent, <span class="at">dest_country_name =</span> country_name) <span class="sc">%&gt;%</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add continent to "unknown countries" bins</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">origin_country_name =</span> <span class="fu">if_else</span>(</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">str_detect</span>(origin_country_name, <span class="st">"unknown countries"</span>),</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(origin_continent, <span class="st">": unknown countries"</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>      origin_country_name),</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a few us territories aren't on the origin map, so let's fill them in again</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># for the destination list</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">dest_country_name =</span> <span class="fu">coalesce</span>(dest_country_name,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">countrycode</span>(dest_country_code, <span class="st">"iso3c"</span>, <span class="st">"country.name"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"origin"</span>), <span class="fu">starts_with</span>(<span class="st">"dest"</span>), year, value, magnitude, qualifier) <span class="sc">%&gt;%</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"student-flows-tidy.csv"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>national_data_joined</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>Warning in countrycode_convert(sourcevar = sourcevar, origin = origin, destination = dest, : Some values were not matched unambiguously: ANT, XDN</code></pre>
</div>
</div>
<p>Before we start visualising, let’s now break this back into data by origin and by destination. That way, we can <a href="https://forcats.tidyverse.org/reference/fct_lump.html">lump</a> all the same values together and make a more compact statement about the main comings and goings for a given country.</p>
<div class="cell" data-hash="analysis_cache/html/lumping_62e27efc7804ca6eec5d81e52ac5ddd1">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb20"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># most popular destinations for each origin</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>national_data_joined <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value), value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, origin_country_name) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dest_country_lumped =</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fct_lump_n</span>(<span class="at">f =</span> dest_country_name, <span class="at">n =</span> <span class="dv">10</span>, <span class="at">w =</span> value,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">other =</span> <span class="st">"Other countries"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now add up all the lumped ones</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(origin_country_name, dest_country_lumped, year, value, magnitude,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    qualifier) <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, origin_country_name, dest_country_lumped) <span class="sc">%&gt;%</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_lumped =</span> <span class="fu">sum</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also format labels for qualifiers</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_includes =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(magnitude <span class="sc">==</span> <span class="st">"INCLUDES"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"a"</span>, <span class="st">"-"</span>),</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_included =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(magnitude <span class="sc">==</span> <span class="st">"INCLUDED"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"b"</span>, <span class="st">"-"</span>),</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_natest =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(qualifier <span class="sc">==</span> <span class="st">"NAT_EST"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"c"</span>, <span class="st">"-"</span>),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_uisest =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(qualifier <span class="sc">==</span> <span class="st">"UIS_EST"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"d"</span>, <span class="st">"-"</span>),</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_all =</span> <span class="fu">str_trim</span>(<span class="fu">paste</span>(cond_includes, cond_included, cond_natest,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      cond_uisest, <span class="at">collapse =</span> <span class="st">","</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, origin_country_name, dest_country_lumped, value_lumped,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    cond_all) <span class="sc">%&gt;%</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"popular-destinations-by-origin.csv"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>popular_destinations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year', 'origin_country_name'. You can override using the `.groups` argument.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb22"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># most popular origins for each destination</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>national_data_joined <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value), value <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, dest_country_name) <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">origin_country_lumped =</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fct_lump_n</span>(<span class="at">f =</span> origin_country_name, <span class="at">n =</span> <span class="dv">10</span>, <span class="at">w =</span> value,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">other =</span> <span class="st">"Other countries"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now add up all the lumped ones</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dest_country_name, origin_country_lumped, year, value, magnitude, qualifier) <span class="sc">%&gt;%</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, dest_country_name, origin_country_lumped) <span class="sc">%&gt;%</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">value_lumped =</span> <span class="fu">sum</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># also format labels for qualifiers</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_includes =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(magnitude <span class="sc">==</span> <span class="st">"INCLUDES"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"a"</span>, <span class="st">"-"</span>),</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_included =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(magnitude <span class="sc">==</span> <span class="st">"INCLUDED"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"b"</span>, <span class="st">"-"</span>),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_natest =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(qualifier <span class="sc">==</span> <span class="st">"NAT_EST"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"c"</span>, <span class="st">"-"</span>),</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_uisest =</span> <span class="fu">if_else</span>(<span class="fu">any</span>(qualifier <span class="sc">==</span> <span class="st">"UIS_EST"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"d"</span>, <span class="st">"-"</span>),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">cond_all =</span> <span class="fu">str_trim</span>(<span class="fu">paste</span>(cond_includes, cond_included, cond_natest,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      cond_uisest, <span class="at">collapse =</span> <span class="st">","</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, dest_country_name, origin_country_lumped, value_lumped,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    cond_all) <span class="sc">%&gt;%</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"popular-origins-by-destination.csv"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>popular_origins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year', 'dest_country_name'. You can override using the `.groups` argument.</code></pre>
</div>
</div>
<div class="cell" data-hash="analysis_cache/html/exportdata_2d8cd53057c9a91dbc0784b963c6d23e">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># list of countries</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  national_data_joined<span class="sc">$</span>origin_country_name,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  national_data_joined<span class="sc">$</span>dest_country_name) <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">discard</span>(is.na) <span class="sc">%&gt;%</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ojs_define</span>(<span class="at">country_list =</span> .)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># full, lumped datasets</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> - load exported CSVs instead to reduce embed load</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ojs_define</span>(<span class="at">popDestinations =</span> popular_destinations)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ojs_define</span>(<span class="at">popOrigins =</span> popular_origins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="visualisation-single-country-flows" class="level2">
<h2 class="anchored" data-anchor-id="visualisation-single-country-flows">Visualisation: single country flows</h2>
<p>Let’s start by looking at who comes <em>from</em> and <em>to</em> any given country.</p>
<div id="bycountrycontrols" class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb25" data-startfrom="253" data-source-offset="-0"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 252;"><span id="cb25-253"><a href="#cb25-253" aria-hidden="true" tabindex="-1"></a>viewof basisSelect <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(country_list<span class="op">,</span> {</span>
<span id="cb25-254"><a href="#cb25-254" aria-hidden="true" tabindex="-1"></a>  <span class="dt">label</span><span class="op">:</span> <span class="st">"Country"</span><span class="op">,</span></span>
<span id="cb25-255"><a href="#cb25-255" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sort</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb25-256"><a href="#cb25-256" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb25-257"><a href="#cb25-257" aria-hidden="true" tabindex="-1"></a>viewof yearSelect <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>([<span class="dv">1998</span><span class="op">,</span> <span class="dv">2021</span>]<span class="op">,</span></span>
<span id="cb25-258"><a href="#cb25-258" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">step</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Year"</span>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="bycountrycontrols-1">
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div id="bycountrycontrols-2">
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell" data-0="l" data-1="a" data-2="b" data-3="e" data-4="l" data-5=":" data-6="b" data-7="y" data-8="c" data-9="o" data-10="u" data-11="n" data-12="t" data-13="r" data-14="y" data-15="p" data-16="r" data-17="e" data-18="p" data-19="r" data-20="o" data-21="c" data-22="e" data-23="s" data-24="s" data-25="i" data-26="n" data-27="g">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb26" data-startfrom="265" data-source-offset="-42"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 264;"><span id="cb26-265"><a href="#cb26-265" aria-hidden="true" tabindex="-1"></a>originByCountry <span class="op">=</span> <span class="fu">transpose</span>(popOrigins)<span class="op">.</span><span class="fu">filter</span>(<span class="kw">function</span>(row) {</span>
<span id="cb26-266"><a href="#cb26-266" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> row<span class="op">.</span><span class="at">dest_country_name</span> <span class="op">==</span> basisSelect<span class="op">;</span></span>
<span id="cb26-267"><a href="#cb26-267" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb26-268"><a href="#cb26-268" aria-hidden="true" tabindex="-1"></a>destinationByCountry <span class="op">=</span> <span class="fu">transpose</span>(popDestinations)<span class="op">.</span><span class="fu">filter</span>(<span class="kw">function</span>(row) {</span>
<span id="cb26-269"><a href="#cb26-269" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> row<span class="op">.</span><span class="at">origin_country_name</span> <span class="op">==</span> basisSelect<span class="op">;</span></span>
<span id="cb26-270"><a href="#cb26-270" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb26-271"><a href="#cb26-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-272"><a href="#cb26-272" aria-hidden="true" tabindex="-1"></a><span class="co">// compute a fixed x range for a given country across all years, in and out</span></span>
<span id="cb26-273"><a href="#cb26-273" aria-hidden="true" tabindex="-1"></a>countryMax <span class="op">=</span> d3<span class="op">.</span><span class="fu">max</span>([</span>
<span id="cb26-274"><a href="#cb26-274" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">max</span>(originByCountry<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value_lumped</span>)<span class="op">,</span></span>
<span id="cb26-275"><a href="#cb26-275" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">max</span>(destinationByCountry<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">value_lumped</span>)</span>
<span id="cb26-276"><a href="#cb26-276" aria-hidden="true" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb26-277"><a href="#cb26-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-278"><a href="#cb26-278" aria-hidden="true" tabindex="-1"></a><span class="co">// further filter data by selected year</span></span>
<span id="cb26-279"><a href="#cb26-279" aria-hidden="true" tabindex="-1"></a>filteredPopularOrigins <span class="op">=</span> originByCountry<span class="op">.</span><span class="fu">filter</span>(<span class="kw">function</span>(row) {</span>
<span id="cb26-280"><a href="#cb26-280" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> row<span class="op">.</span><span class="at">year</span> <span class="op">==</span> yearSelect<span class="op">;</span></span>
<span id="cb26-281"><a href="#cb26-281" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb26-282"><a href="#cb26-282" aria-hidden="true" tabindex="-1"></a>filteredPopularDestinations <span class="op">=</span> destinationByCountry<span class="op">.</span><span class="fu">filter</span>(<span class="kw">function</span>(row) {</span>
<span id="cb26-283"><a href="#cb26-283" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> row<span class="op">.</span><span class="at">year</span> <span class="op">==</span> yearSelect<span class="op">;</span></span>
<span id="cb26-284"><a href="#cb26-284" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb26-285"><a href="#cb26-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-286"><a href="#cb26-286" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(filteredPopularOrigins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-6" data-nodetype="expression">

</div>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb27" data-startfrom="287" data-source-offset="-775"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 286;"><span id="cb27-287"><a href="#cb27-287" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(filteredPopularDestinations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-7" data-nodetype="expression">

</div>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb28" data-startfrom="289" data-source-offset="-817"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 288;"><span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a>commaFormat <span class="op">=</span> d3<span class="op">.</span><span class="fu">format</span>(<span class="st">",.0f"</span>)<span class="op">;</span></span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>noDataInMessage <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div style="width:475px;padding-top:25px;display:flex;"&gt;&lt;p style="margin:auto;"&gt;No data for student flows &lt;strong&gt;into </span><span class="sc">${</span>basisSelect<span class="sc">}</span><span class="vs">&lt;/strong&gt; in &lt;strong&gt;</span><span class="sc">${</span>yearSelect<span class="sc">}</span><span class="vs">&lt;/strong&gt;.&lt;/p&gt;&lt;div&gt;`</span></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>noDataOutMessage <span class="op">=</span> <span class="fu">html</span><span class="vs">`&lt;div style="width:475px;padding-top:25px;display:flex;"&gt;&lt;p style="margin:auto;"&gt;No data for student flows &lt;strong&gt;out of </span><span class="sc">${</span>basisSelect<span class="sc">}</span><span class="vs">&lt;/strong&gt; in &lt;strong&gt;</span><span class="sc">${</span>yearSelect<span class="sc">}</span><span class="vs">&lt;/strong&gt;.&lt;/p&gt;&lt;div&gt;`</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-8" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-9" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-2-10" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb29" data-startfrom="297" data-source-offset="-0"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 296;"><span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a>popOriginPlot <span class="op">=</span> filteredPopularOrigins<span class="op">.</span><span class="at">length</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span></span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a>  noDataInMessage <span class="op">:</span></span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a>  Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(filteredPopularOrigins<span class="op">,</span> {</span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"origin_country_lumped"</span><span class="op">,</span></span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"value_lumped"</span><span class="op">,</span></span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"value_lumped"</span><span class="op">,</span></span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sort</span><span class="op">:</span> {<span class="dt">y</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a>      <span class="co">// label for value on left</span></span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(filteredPopularOrigins<span class="op">,</span> {</span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"origin_country_lumped"</span><span class="op">,</span></span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"value_lumped"</span><span class="op">,</span></span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a>        <span class="co">// add conditions to value label if required</span></span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> {</span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (d<span class="op">.</span><span class="at">cond_all</span> <span class="op">==</span> <span class="st">"----"</span>) { </span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a>            <span class="fu">commaFormat</span>(d<span class="op">.</span><span class="at">value_lumped</span>)</span>
<span id="cb29-315"><a href="#cb29-315" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb29-316"><a href="#cb29-316" aria-hidden="true" tabindex="-1"></a>            <span class="fu">commaFormat</span>(d<span class="op">.</span><span class="at">value_lumped</span>) <span class="op">+</span> <span class="st">" ("</span> <span class="op">+</span> d<span class="op">.</span><span class="at">cond_all</span> <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dx</span><span class="op">:</span> <span class="op">-</span><span class="dv">25</span></span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"← Number of students from..."</span><span class="op">,</span></span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelOffset</span><span class="op">:</span> <span class="dv">45</span><span class="op">,</span></span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> countryMax]<span class="op">,</span></span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a>      <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span> }<span class="op">,</span></span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">""</span><span class="op">,</span> <span class="dt">axis</span><span class="op">:</span> <span class="st">"right"</span> }<span class="op">,</span></span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> { <span class="dt">scheme</span><span class="op">:</span> <span class="st">"ylgnbu"</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"sqrt"</span> }<span class="op">,</span></span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">475</span><span class="op">,</span></span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">65</span><span class="op">,</span></span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">140</span><span class="op">,</span></span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontFamily</span><span class="op">:</span> <span class="st">"'Libre Franklin'"</span><span class="op">,</span></span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontSize</span><span class="op">:</span> <span class="st">"16px"</span></span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>    <span class="co">// caption: html`Which countries send students here?`</span></span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="bycountryorigins" class="cell-output-display">
<div id="ojs-cell-3" data-nodetype="declaration">

</div>
</div>
</div>
<p>Where do this country’s students go?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb30" data-startfrom="344" data-source-offset="-0"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 343;"><span id="cb30-344"><a href="#cb30-344" aria-hidden="true" tabindex="-1"></a>popDestinationPlot <span class="op">=</span> </span>
<span id="cb30-345"><a href="#cb30-345" aria-hidden="true" tabindex="-1"></a>  filteredPopularDestinations<span class="op">.</span><span class="at">length</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span></span>
<span id="cb30-346"><a href="#cb30-346" aria-hidden="true" tabindex="-1"></a>  noDataOutMessage <span class="op">:</span></span>
<span id="cb30-347"><a href="#cb30-347" aria-hidden="true" tabindex="-1"></a>  Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb30-348"><a href="#cb30-348" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb30-349"><a href="#cb30-349" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barX</span>(filteredPopularDestinations<span class="op">,</span> {</span>
<span id="cb30-350"><a href="#cb30-350" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"dest_country_lumped"</span><span class="op">,</span></span>
<span id="cb30-351"><a href="#cb30-351" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"value_lumped"</span><span class="op">,</span></span>
<span id="cb30-352"><a href="#cb30-352" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fill</span><span class="op">:</span> <span class="st">"value_lumped"</span><span class="op">,</span></span>
<span id="cb30-353"><a href="#cb30-353" aria-hidden="true" tabindex="-1"></a>        <span class="dt">sort</span><span class="op">:</span> {<span class="dt">y</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">reverse</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb30-354"><a href="#cb30-354" aria-hidden="true" tabindex="-1"></a>      })<span class="op">,</span></span>
<span id="cb30-355"><a href="#cb30-355" aria-hidden="true" tabindex="-1"></a>      <span class="co">// label for value on right</span></span>
<span id="cb30-356"><a href="#cb30-356" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">text</span>(filteredPopularDestinations<span class="op">,</span> {</span>
<span id="cb30-357"><a href="#cb30-357" aria-hidden="true" tabindex="-1"></a>        <span class="dt">y</span><span class="op">:</span> <span class="st">"dest_country_lumped"</span><span class="op">,</span></span>
<span id="cb30-358"><a href="#cb30-358" aria-hidden="true" tabindex="-1"></a>        <span class="dt">x</span><span class="op">:</span> <span class="st">"value_lumped"</span><span class="op">,</span></span>
<span id="cb30-359"><a href="#cb30-359" aria-hidden="true" tabindex="-1"></a>        <span class="co">// add conditions to value label if required</span></span>
<span id="cb30-360"><a href="#cb30-360" aria-hidden="true" tabindex="-1"></a>        <span class="dt">text</span><span class="op">:</span> d <span class="kw">=&gt;</span> {</span>
<span id="cb30-361"><a href="#cb30-361" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (d<span class="op">.</span><span class="at">cond_all</span> <span class="op">==</span> <span class="st">"----"</span>) { </span>
<span id="cb30-362"><a href="#cb30-362" aria-hidden="true" tabindex="-1"></a>            <span class="fu">commaFormat</span>(d<span class="op">.</span><span class="at">value_lumped</span>)</span>
<span id="cb30-363"><a href="#cb30-363" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb30-364"><a href="#cb30-364" aria-hidden="true" tabindex="-1"></a>            <span class="fu">commaFormat</span>(d<span class="op">.</span><span class="at">value_lumped</span>) <span class="op">+</span> <span class="st">" ("</span> <span class="op">+</span> d<span class="op">.</span><span class="at">cond_all</span> <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb30-365"><a href="#cb30-365" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb30-366"><a href="#cb30-366" aria-hidden="true" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb30-367"><a href="#cb30-367" aria-hidden="true" tabindex="-1"></a>        <span class="dt">dx</span><span class="op">:</span> <span class="dv">25</span></span>
<span id="cb30-368"><a href="#cb30-368" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb30-369"><a href="#cb30-369" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb30-370"><a href="#cb30-370" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb30-371"><a href="#cb30-371" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Number of students going to →"</span><span class="op">,</span></span>
<span id="cb30-372"><a href="#cb30-372" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelOffset</span><span class="op">:</span> <span class="dv">45</span><span class="op">,</span></span>
<span id="cb30-373"><a href="#cb30-373" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> countryMax]</span>
<span id="cb30-374"><a href="#cb30-374" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb30-375"><a href="#cb30-375" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> { <span class="dt">label</span><span class="op">:</span> <span class="st">""</span> }<span class="op">,</span></span>
<span id="cb30-376"><a href="#cb30-376" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> { <span class="dt">scheme</span><span class="op">:</span> <span class="st">"ylorrd"</span><span class="op">,</span> <span class="dt">type</span><span class="op">:</span> <span class="st">"sqrt"</span> }<span class="op">,</span></span>
<span id="cb30-377"><a href="#cb30-377" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">475</span><span class="op">,</span></span>
<span id="cb30-378"><a href="#cb30-378" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">140</span><span class="op">,</span></span>
<span id="cb30-379"><a href="#cb30-379" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginRight</span><span class="op">:</span> <span class="dv">65</span><span class="op">,</span></span>
<span id="cb30-380"><a href="#cb30-380" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">40</span><span class="op">,</span></span>
<span id="cb30-381"><a href="#cb30-381" aria-hidden="true" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb30-382"><a href="#cb30-382" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontFamily</span><span class="op">:</span> <span class="st">"'Libre Franklin'"</span><span class="op">,</span></span>
<span id="cb30-383"><a href="#cb30-383" aria-hidden="true" tabindex="-1"></a>      <span class="dt">fontSize</span><span class="op">:</span> <span class="st">"16px"</span></span>
<span id="cb30-384"><a href="#cb30-384" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-385"><a href="#cb30-385" aria-hidden="true" tabindex="-1"></a>    <span class="co">// caption: html`Where do this country's students go?`</span></span>
<span id="cb30-386"><a href="#cb30-386" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="bycountrydestinations" class="cell-output-display">
<div id="ojs-cell-4" data-nodetype="declaration">

</div>
</div>
</div>
</section>
<section id="net-flow-indicators" class="level2">
<h2 class="anchored" data-anchor-id="net-flow-indicators">Net flow indicators</h2>
<p>Also of interest are these two indicators:</p>
<ul>
<li><code>MENF.5T8</code>: “Net flow of internationally mobile students (inbound - outbound), both sexes (number)”</li>
<li><code>MENFR.5T8</code>: “Net flow ratio of internationally mobile students (inbound - outbound), both sexes (%)”</li>
</ul>
<p>Let’s see whether countries that have a net flow one way or the other tend to rank highly or lowly on the Human Development Index.</p>
<p>First we need to grab those two indicators and tidy them up:</p>
<div class="cell" data-hash="analysis_cache/html/netflow_eba96ec9ffcbf64e4af4c4c0cd17cdae">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb31"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>national_data <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(INDICATOR_ID <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"MENF.5T8"</span>, <span class="st">"MENFR.5T8"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(indicator_origin_map, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"COUNTRY_ID"</span> <span class="ot">=</span> <span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">indicator =</span> <span class="fu">recode</span>(INDICATOR_ID.x,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MENF.5T8"</span> <span class="ot">=</span> <span class="st">"flow_value"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"MENFR.5T8"</span> <span class="ot">=</span> <span class="st">"flow_ratio"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> indicator, <span class="at">values_from =</span> VALUE) <span class="sc">%&gt;%</span> </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">year =</span> YEAR, continent, <span class="at">country_code =</span> COUNTRY_ID, country_name,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    flow_value, flow_ratio, <span class="at">magnitude =</span> MAGNITUDE, <span class="at">qualifier =</span> QUALIFIER) <span class="ot">-&gt;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>netflows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s also bring Human Development Index data in to compare against. <a href="https://ourworldindata.org/human-development-index">Our World in Data</a> has the tidiest version of this:</p>
<div class="cell" data-hash="analysis_cache/html/hdijoin_240bb28fcd36a29c6a238f9a7818588c">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb32"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># from https://hdr.undp.org/en/indicators/137506</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># via https://ourworldindata.org/human-development-index</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># but not iso3c codes!</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"hdi-owid.csv"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_names</span>(<span class="fu">c</span>(<span class="st">"country_name"</span>, <span class="st">"country_code"</span>, <span class="st">"year"</span>, <span class="st">"hdi"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>hdi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>Rows: 5001 Columns: 4</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (2): Entity, Code
dbl (2): Year, Human Development Index (UNDP)</code></pre>
</div>
<div class="cell-output-stderr">
<pre><code>
ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb36"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># join the net flow data with owid hdi data</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>netflows <span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(hdi, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>, <span class="st">"year"</span>), <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">".uis"</span>, <span class="st">".owid"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">country_name =</span> <span class="fu">coalesce</span>(country_name.uis, country_name.owid)) <span class="sc">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, continent, country_code, country_name, flow_value, flow_ratio,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  hdi) <span class="ot">-&gt;</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>netflows_hdi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="analysis_cache/html/vishdi_97631e6efb3e488f44b25803a2de06a3">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb37"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>netflows_hdi <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(flow_ratio), <span class="sc">!</span><span class="fu">is.na</span>(hdi)) <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">flow_sign =</span> <span class="fu">if_else</span>(flow_ratio <span class="sc">&gt;=</span> <span class="dv">0</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Net gain of students"</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Net loss of students"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(.) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">x =</span> hdi, <span class="at">y =</span> flow_ratio, <span class="at">colour =</span> flow_sign) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">unname</span>(<span class="fu">colours_360</span>(<span class="st">"blues"</span>))) <span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(year)) <span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ylim</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">100</span>)) <span class="sc">+</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>) <span class="sc">+</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Human development index"</span>,</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Net student flow (%)"</span>,</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="st">"Net flow"</span>)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>Warning: Removed 25 rows containing missing values (geom_point).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="analysis_files/figure-html/vishdi-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb39"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>netflows_hdi <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter out missing data for ojs transpose()</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(flow_ratio), <span class="sc">!</span><span class="fu">is.na</span>(hdi)) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, country_name, flow_ratio, hdi) <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"netflows.csv"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ojs_define</span>(<span class="at">netflows =</span> .)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So here’s what our net flows look like interactively (hover for a second to see country info):</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb40" data-startfrom="470" data-source-offset="-0"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 469;"><span id="cb40-470"><a href="#cb40-470" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {viewof flowYearSelect<span class="op">,</span> netflowScatterChart} <span class="im">from</span></span>
<span id="cb40-471"><a href="#cb40-471" aria-hidden="true" tabindex="-1"></a>  <span class="st">"./embed-netflow-scatter.qmd"</span></span>
<span id="cb40-472"><a href="#cb40-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-473"><a href="#cb40-473" aria-hidden="true" tabindex="-1"></a>viewof flowYearSelect<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<div id="ojs-cell-5-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output-display">
<div>
<div id="ojs-cell-5-2" data-nodetype="expression">

</div>
</div>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb41" data-startfrom="474" data-source-offset="-113"><pre class="sourceCode js cell-code code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 473;"><span id="cb41-474"><a href="#cb41-474" aria-hidden="true" tabindex="-1"></a>netflowScatterChart<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<div id="ojs-cell-5-3" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>It seems that a <em>subset</em> of high-HDI countries (not all) are the ones that tend to receive students.</p>
</section>
<section id="net-flow-map" class="level2">
<h2 class="anchored" data-anchor-id="net-flow-map">Net flow map</h2>
<p>These indicators tell us the net flow in or out of any given country, but I’d really like to know the net flow across any <em>pair</em> of countries. Let’s return to the country-to-country data, <code>national_data_joined</code>, and try to work that out.</p>
<p>First, let’s get the spatial data (country centroids) needed to make a map. I first used <code>{rnaturalearth}</code> for this, but I found <code>CoordinateCleaner</code> (which uses the CIA Fact Book) to be considerably more complete:</p>
<div class="cell" data-hash="analysis_cache/html/unnamed-chunk-22_aeb5ce73605f4a20d2eedff8c09480bc">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb42"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(countryref)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>countryref <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(source)) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">country_code =</span> iso3, centroid.lat, centroid.lon) <span class="sc">%&gt;%</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"centroid.lat"</span>, <span class="st">"centroid.lon"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(country_code, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="ot">-&gt;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>boundaries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s check against all the countries in our data to ensure we’re not missing any centroids. ::: {.cell hash=‘analysis_cache/html/countrylist_146a80d0d004ec07b84ddaab3af03ea1’}</p>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb43"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  national_data_joined <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"origin_"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"origin_"</span>, <span class="st">""</span>)),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  national_data_joined <span class="sc">%&gt;%</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"dest_"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_replace</span>(.x, <span class="st">"dest_"</span>, <span class="st">""</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, country_name, continent) <span class="sc">%&gt;%</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(country_code)) <span class="ot">-&gt;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>country_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<p>:::</p>
<p>Looks like we’re missing just one: pre-secession Sudan (<code>XDN</code>). ::: {.cell hash=‘analysis_cache/html/missingcentroids_a7bb5993524ec6a4271ae5fec0339c72’}</p>
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb44"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setdiff</span>(country_list<span class="sc">$</span>country_code, boundaries<span class="sc">$</span>country_code) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  { <span class="fu">filter</span>(country_list, country_code <span class="sc">%in%</span> .) } <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stdout">
<pre><code># A tibble: 1 × 3
  country_code country_name          continent
  &lt;chr&gt;        &lt;chr&gt;                 &lt;chr&gt;    
1 XDN          Sudan (pre-secession) Africa   </code></pre>
</div>
<p>:::</p>
<p>I’ll add it manually (we don’t need the centroids to be too precise). I’ve also dropped a “null” point from this dataset labelled <code>NUL</code>:</p>
<div class="cell" data-hash="analysis_cache/html/sudanpatch_bb8c9d2e5072da8e843e78ff8e252bbe">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb46"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>boundaries <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">country_code =</span> <span class="st">"XDN"</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">geometry =</span> <span class="fu">st_sfc</span>(<span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">12.76555</span>, <span class="fl">29.91269</span>))))) <span class="sc">%&gt;%</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country_code <span class="sc">!=</span> <span class="st">"NUL"</span>) <span class="ot">-&gt;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>country_centroids</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="aside-country-pair-net-flows" class="level3">
<h3 class="anchored" data-anchor-id="aside-country-pair-net-flows">Aside: country-pair net flows</h3>
<p>I’d been hoping to simplify any network visualisation of student flows by only showing the net flow between any two countries.</p>
<p>Unfortunately, the data isn’t quite good enough for this. The below code pivots the network of student flows to try and calculate net flow, but there’s enough data missing that you’re losing a large part of it by requiring both sides (in other words, if either country’s departing flow is <code>NA</code>, so is the net flow).</p>
<p>Nevertheless, the code is below for reproduction purposes!</p>
<div class="cell" data-hash="analysis_cache/html/netflowaside_01230f9fe8c8f9f87c872822b7412d42">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb47"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>national_data_joined <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, <span class="at">origin =</span> origin_country_code, <span class="at">dest =</span> dest_country_code,</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    value, magnitude, qualifier) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(origin), <span class="sc">!</span><span class="fu">is.na</span>(dest)) <span class="sc">%&gt;%</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># now create a two-country key and direction for the pivot</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> <span class="fu">if_else</span>(origin <span class="sc">&lt;</span> dest, <span class="st">"toB"</span>, <span class="st">"toA"</span>),</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pairkey =</span> <span class="fu">paste</span>(<span class="fu">pmin</span>(origin, dest), <span class="fu">pmax</span>(origin, dest), <span class="at">sep =</span> <span class="st">"_"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(pairkey, year), <span class="at">names_from =</span> direction,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> <span class="fu">c</span>(value, magnitude, qualifier)) <span class="sc">%&gt;%</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(pairkey, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"countryA"</span>, <span class="st">"countryB"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ditch the extra country columns</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, countryA, countryB,</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"value"</span>),</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"magnitude"</span>),</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">starts_with</span>(<span class="st">"qualifier"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate net flow</span></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">netflow =</span> <span class="fu">abs</span>(value_toB <span class="sc">-</span> value_toA),</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">net_destination =</span> <span class="fu">if_else</span>(</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>      value_toB <span class="sc">&gt;</span> value_toA,</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>      countryB,</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>      countryA)) <span class="sc">%&gt;%</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tidy-countrypair-netflows.csv"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>countrypair_netflows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="flow-maps" class="level3">
<h3 class="anchored" data-anchor-id="flow-maps">Flow maps</h3>
<p>Let’s return to showing <em>all</em> the student flows. This will be messy, but some judicious use of opacity might make things clearer.</p>
<div class="cell" data-hash="analysis_cache/html/unnamed-chunk-28_240824c76d1452584edee35a4b2bee63">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb48"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># bring the country centroid and hdi info in and create lines between countries</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (this is a bit colvoluted but was the only performant solution i could find to</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co"># creating two-point linestrings)</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co"># (also note that {CoordinateCleaner}'s points appear to be Y/X rather than X/Y.</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co"># this code is a little weird to read as a result)</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>national_data_joined <span class="sc">%&gt;%</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(country_centroids,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"origin_country_code"</span> <span class="ot">=</span> <span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(hdi, <span class="sc">-</span>country_name),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"origin_country_code"</span> <span class="ot">=</span> <span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">origin_pt =</span> geometry, <span class="at">origin_hdi =</span> hdi) <span class="sc">%&gt;%</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(country_centroids,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"dest_country_code"</span> <span class="ot">=</span> <span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(hdi, <span class="sc">-</span>country_name),</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"dest_country_code"</span> <span class="ot">=</span> <span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">dest_pt =</span> geometry, <span class="at">dest_hdi =</span> hdi) <span class="sc">%&gt;%</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># extract pt coordinates out to cols</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">st_is_empty</span>(origin_pt), <span class="sc">!</span><span class="fu">st_is_empty</span>(dest_pt)) <span class="sc">%&gt;%</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">origin_coord =</span> <span class="fu">st_coordinates</span>(origin_pt),</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">dest_coord =</span> <span class="fu">st_coordinates</span>(dest_pt),</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (note flipping X and Y because {CoordinateCleaner}'s points are around the</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># wrong way)</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">origin_lat =</span> origin_coord[, <span class="st">"X"</span>],</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">origin_lon =</span> origin_coord[, <span class="st">"Y"</span>],</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">dest_lat =</span> dest_coord[, <span class="st">"X"</span>],</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">dest_lon =</span> dest_coord[, <span class="st">"Y"</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="fu">pmap</span>(</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(., origin_lon, origin_lat, dest_lon, dest_lat),</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">st_linestring</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(..<span class="dv">1</span>, ..<span class="dv">2</span>, ..<span class="dv">3</span>, ..<span class="dv">4</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>))),</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">path =</span> <span class="fu">st_sfc</span>(path)) <span class="ot">-&gt;</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>flows_all_df</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>flows_all_df <span class="sc">%&gt;%</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"pt"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"coord"</span>), <span class="sc">-</span>path) <span class="sc">%&gt;%</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"flows-all.csv"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"continent"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"country_name"</span>),</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"country_code"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"flows-all-lean.csv"</span>))</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>flows_all_df <span class="sc">%&gt;%</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"lon"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"lat"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"coord"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>), <span class="at">sf_column_name =</span> <span class="st">"path"</span>) <span class="ot">-&gt;</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>flows_all</span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="co"># write out to disk</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a><span class="fu">st_write</span>(flows_all, <span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"flows_all.gpkg"</span>), <span class="at">delete_dsn =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>Warning in clean_columns(as.data.frame(obj), factorsAsCharacter): Dropping
column(s) origin_pt,dest_pt of class(es) sfc_POINT;sfc,sfc_POINT;sfc</code></pre>
</div>
<div class="cell-output-stdout">
<pre><code>Deleting source `/Users/jgol0005/Code/report-global-education/data/flows_all.gpkg' using driver `GPKG'
Writing layer `flows_all' to data source 
  `/Users/jgol0005/Code/report-global-education/data/flows_all.gpkg' using driver `GPKG'
Writing 408896 features with 12 fields and geometry type Line String.</code></pre>
</div>
</div>
</section>
</section>
<section id="grouped-country-flows" class="level2">
<h2 class="anchored" data-anchor-id="grouped-country-flows">Grouped country flows</h2>
<p>Let’s group our countries by HDI and work out the flows between those groups each year</p>
<div class="cell" data-hash="analysis_cache/html/groupedhdiflows_8f762f85796b0981778bc2bad6fcb633">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb51"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>flows_all <span class="sc">%&gt;%</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(origin_hdi), <span class="sc">!</span><span class="fu">is.na</span>(dest_hdi)) <span class="sc">%&gt;%</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bin the hdis</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">origin_hdi_bin =</span> <span class="fu">cut</span>(origin_hdi, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.7</span>, <span class="fl">0.85</span>, <span class="dv">1</span>),</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"Medium"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"High"</span>)),</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dest_hdi_bin =</span> <span class="fu">cut</span>(dest_hdi, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.7</span>, <span class="fl">0.85</span>, <span class="dv">1</span>),</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"Medium"</span>,</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"High"</span>))) <span class="ot">-&gt;</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>flows_binned</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>flows_binned <span class="sc">%&gt;%</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(year, origin_hdi_bin, dest_hdi_bin, value) <span class="sc">%&gt;%</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, origin_hdi_bin, dest_hdi_bin) <span class="sc">%&gt;%</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">students =</span> <span class="fu">sum</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(<span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"netflows-hdigroups.csv"</span>)) <span class="ot">-&gt;</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>flows_hdigroups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'year', 'origin_hdi_bin'. You can override
using the `.groups` argument.</code></pre>
</div>
</div>
<div class="cell" data-hash="analysis_cache/html/vishdigroups_c8a0a0a7c04cdc0f8bdd8e9373f34949">
<details>
<summary>Code</summary>
<div class="sourceCode" id="cb53"><pre class="sourceCode r cell-code code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>flows_hdigroups <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lab =</span> scales<span class="sc">::</span><span class="fu">label_number_si</span>(<span class="at">accuracy =</span> <span class="fl">0.1</span>)(students)) <span class="sc">%&gt;%</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(.) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">y =</span> origin_hdi_bin, <span class="at">x =</span> dest_hdi_bin) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">fill =</span> students)) <span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> lab),</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">colour =</span> <span class="fu">alpha</span>(<span class="st">"white"</span>, <span class="fl">0.25</span>)) <span class="sc">+</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(year)) <span class="sc">+</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Destination countries"</span>,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Origin countries"</span>)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="analysis_files/figure-html/vishdigroups-1.png" class="img-fluid" width="672"></p>
</div>
</div>

</section>
</main>
<!-- /main column -->
<script type="ojs-module-contents">
{"contents":[{"methodName":"interpret","cellName":"ojs-cell-1","inline":false,"source":"viewof basisSelect = Inputs.select(country_list, {\n  label: \"Country\",\n  sort: true\n});\nviewof yearSelect = Inputs.range([1998, 2021],\n  {step: 1, label: \"Year\"});"},{"methodName":"interpret","cellName":"ojs-cell-2","inline":false,"source":"\n// first filter data by selected country\noriginByCountry = transpose(popOrigins).filter(function(row) {\n  return row.dest_country_name == basisSelect;\n});\ndestinationByCountry = transpose(popDestinations).filter(function(row) {\n  return row.origin_country_name == basisSelect;\n});\n\n// compute a fixed x range for a given country across all years, in and out\ncountryMax = d3.max([\n  d3.max(originByCountry, d => d.value_lumped),\n  d3.max(destinationByCountry, d => d.value_lumped)\n]);\n\n// further filter data by selected year\nfilteredPopularOrigins = originByCountry.filter(function(row) {\n  return row.year == yearSelect;\n});\nfilteredPopularDestinations = destinationByCountry.filter(function(row) {\n  return row.year == yearSelect;\n});\n\nconsole.log(filteredPopularOrigins)\nconsole.log(filteredPopularDestinations)\n\ncommaFormat = d3.format(\",.0f\");\nnoDataInMessage = html`<div style=\"width:475px;padding-top:25px;display:flex;\"><p style=\"margin:auto;\">No data for student flows <strong>into ${basisSelect}</strong> in <strong>${yearSelect}</strong>.</p><div>`\n\nnoDataOutMessage = html`<div style=\"width:475px;padding-top:25px;display:flex;\"><p style=\"margin:auto;\">No data for student flows <strong>out of ${basisSelect}</strong> in <strong>${yearSelect}</strong>.</p><div>`"},{"methodName":"interpret","cellName":"ojs-cell-3","inline":false,"source":"popOriginPlot = filteredPopularOrigins.length == 0 ?\n  noDataInMessage :\n  Plot.plot({\n    marks: [\n      Plot.barX(filteredPopularOrigins, {\n        y: \"origin_country_lumped\",\n        x: \"value_lumped\",\n        fill: \"value_lumped\",\n        sort: {y: \"x\", reverse: true}\n      }),\n      // label for value on left\n      Plot.text(filteredPopularOrigins, {\n        y: \"origin_country_lumped\",\n        x: \"value_lumped\",\n        // add conditions to value label if required\n        text: d => {\n          if (d.cond_all == \"----\") { \n            commaFormat(d.value_lumped)\n          } else {\n            commaFormat(d.value_lumped) + \" (\" + d.cond_all + \")\"\n          }\n        },\n        dx: -25\n      }),\n    ],\n    x: {\n      label: \"← Number of students from...\",\n      labelOffset: 45,\n      domain: [0, countryMax],\n      reverse: true },\n    y: { label: \"\", axis: \"right\" },\n    color: { scheme: \"ylgnbu\", type: \"sqrt\" },\n    width: 475,\n    marginLeft: 65,\n    marginRight: 140,\n    marginBottom: 40,\n    style: {\n      fontFamily: \"'Libre Franklin'\",\n      fontSize: \"16px\"\n    }\n    // caption: html`Which countries send students here?`\n  });"},{"methodName":"interpret","cellName":"ojs-cell-4","inline":false,"source":"popDestinationPlot = \n  filteredPopularDestinations.length == 0 ?\n  noDataOutMessage :\n  Plot.plot({\n    marks: [\n      Plot.barX(filteredPopularDestinations, {\n        y: \"dest_country_lumped\",\n        x: \"value_lumped\",\n        fill: \"value_lumped\",\n        sort: {y: \"x\", reverse: true}\n      }),\n      // label for value on right\n      Plot.text(filteredPopularDestinations, {\n        y: \"dest_country_lumped\",\n        x: \"value_lumped\",\n        // add conditions to value label if required\n        text: d => {\n          if (d.cond_all == \"----\") { \n            commaFormat(d.value_lumped)\n          } else {\n            commaFormat(d.value_lumped) + \" (\" + d.cond_all + \")\"\n          }\n        },\n        dx: 25\n      })\n    ],\n    x: {\n      label: \"Number of students going to →\",\n      labelOffset: 45,\n      domain: [0, countryMax]\n    },\n    y: { label: \"\" },\n    color: { scheme: \"ylorrd\", type: \"sqrt\" },\n    width: 475,\n    marginLeft: 140,\n    marginRight: 65,\n    marginBottom: 40,\n    style: {\n      fontFamily: \"'Libre Franklin'\",\n      fontSize: \"16px\"\n    }\n    // caption: html`Where do this country's students go?`\n  });"},{"methodName":"interpret","cellName":"ojs-cell-5","inline":false,"source":"import {viewof flowYearSelect, netflowScatterChart} from\n  \"./embed-netflow-scatter.qmd\"\n\nviewof flowYearSelect;\nnetflowScatterChart;"},{"methodName":"interpretQuiet","source":"shinyInput('basisSelect')"},{"methodName":"interpretQuiet","source":"shinyInput('yearSelect')"}]}
</script>
<script type="module">
window._ojs.paths.runtimeToDoc = "../../..";
window._ojs.paths.runtimeToRoot = "../../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    setTimeout(function() {
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->


</body></html>